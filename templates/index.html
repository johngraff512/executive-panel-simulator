<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Executive Panel Simulator - McCombs School of Business</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --texas-orange: #BF5700;
            --texas-orange-light: #E86A00;
            --texas-orange-dark: #9A4600;
            --charcoal: #333F48;
        }
        
        .phase { display: none; animation: fadeIn 0.5s ease-in; }
        .phase.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .mccombs-header {
            background: linear-gradient(135deg, var(--texas-orange), var(--texas-orange-light));
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .mccombs-logo {
            max-height: 60px;
            width: auto;
            margin-right: 1rem;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .executive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .executive-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .executive-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(191, 87, 0, 0.15);
            border-color: var(--texas-orange);
        }
        
        .executive-card input[type="checkbox"] { display: none; }
        
        .executive-card label {
            display: flex;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            margin-bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .executive-card input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, var(--texas-orange), var(--texas-orange-light));
            color: white;
            border-radius: 6px;
        }
        
        .exec-icon {
            font-size: 2rem;
            margin-right: 1rem;
            min-width: 3rem;
            text-align: center;
        }
        
        .conversation-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        
        .message {
            margin-bottom: 1.5rem;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .message.executive .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .message.student .message-header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .executive-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }
        
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--texas-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            margin-left: 0.75rem;
        }
        
        .avatar-CEO { background: #8b5a3c; }
        .avatar-CFO { background: #2e8b57; }
        .avatar-CTO { background: #4169e1; }
        .avatar-CMO { background: #ff6347; }
        .avatar-COO { background: #9370db; }
        
        .message-bubble {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            max-width: 80%;
            position: relative;
        }
        
        .message.executive .message-bubble {
            margin-left: 0;
            border-left: 4px solid var(--texas-orange);
        }
        
        .message.student .message-bubble {
            margin-left: auto;
            background: var(--texas-orange);
            color: white;
            border-left: none;
            border-right: 4px solid var(--texas-orange-dark);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        .message.student .message-time {
            color: rgba(255,255,255,0.8);
        }
        
        .loading-message {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        .executive-member {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid transparent;
        }
        
        .executive-member.active {
            background: #fff3ed;
            border-left-color: var(--texas-orange);
        }
        
        .executive-member .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            margin-right: 0.75rem;
        }
        
        .executive-member .info .name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .executive-member .info .title {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        #student-response {
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
        }
        
        .sticky-top { position: sticky; top: 20px; }
        
        /* Texas Orange themed buttons and form elements */
        .btn-primary {
            background-color: var(--texas-orange);
            border-color: var(--texas-orange);
        }
        
        .btn-primary:hover {
            background-color: var(--texas-orange-dark);
            border-color: var(--texas-orange-dark);
        }
        
        .btn-primary:focus {
            background-color: var(--texas-orange-dark);
            border-color: var(--texas-orange-dark);
            box-shadow: 0 0 0 0.2rem rgba(191, 87, 0, 0.25);
        }
        
        .form-control:focus {
            border-color: var(--texas-orange);
            box-shadow: 0 0 0 0.2rem rgba(191, 87, 0, 0.25);
        }
        
        .form-select:focus {
            border-color: var(--texas-orange);
            box-shadow: 0 0 0 0.2rem rgba(191, 87, 0, 0.25);
        }
        
        .card-header.bg-primary {
            background: linear-gradient(135deg, var(--texas-orange), var(--texas-orange-light)) !important;
        }
        
        .card-header.bg-info {
            background: linear-gradient(135deg, var(--texas-orange-light), var(--texas-orange)) !important;
        }
        
        .card-header.bg-success {
            background: linear-gradient(135deg, var(--texas-orange), var(--texas-orange-dark)) !important;
        }
        
        .card-header.bg-warning {
            background: linear-gradient(135deg, var(--texas-orange-light), var(--texas-orange)) !important;
            color: white !important;
        }
        
        .progress-bar {
            background-color: var(--texas-orange);
        }
        
        .alert-success {
            background-color: #fff3ed;
            border-color: var(--texas-orange-light);
            color: var(--texas-orange-dark);
        }
        
        .btn-info {
            background-color: var(--texas-orange-light);
            border-color: var(--texas-orange-light);
        }
        
        .btn-info:hover {
            background-color: var(--texas-orange);
            border-color: var(--texas-orange);
        }
        
        /* McCombs branding footer */
        .mccombs-footer {
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 3rem;
            padding: 2rem 0;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="mccombs-header">
        <div class="container">
            <div class="navbar-brand mb-0">
                <img src="{{ url_for('static', filename='mccombs-logo.jpg') }}" 
     alt="McCombs School of Business" class="mccombs-logo">
                <div>
                    <div>AI Executive Panel Simulator</div>
                    <small style="font-size: 0.8rem; opacity: 0.9;">McCombs School of Business</small>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Setup Phase -->
        <div id="setup-phase" class="phase active">
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0">
                                <i class="fas fa-upload"></i>
                                Presentation Setup
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="setup-form" enctype="multipart/form-data">
                                <!-- PDF Upload Section -->
                                <div class="mb-4">
                                    <label for="report-pdf" class="form-label">
                                        <i class="fas fa-file-pdf text-danger"></i>
                                        Upload Your Report (PDF)
                                    </label>
                                    <input type="file" class="form-control" id="report-pdf" 
                                           name="report-pdf" accept=".pdf" required>
                                    <small class="text-muted">
                                        Upload your business plan, case analysis, or presentation slides as PDF
                                    </small>
                                </div>

                                <!-- Company & Industry Info -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="company-name" class="form-label">Company Name</label>
                                            <input type="text" class="form-control" id="company-name" 
                                                   name="company-name" placeholder="e.g., Tesla, Amazon, Your Startup" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="industry" class="form-label">Industry</label>
                                            <input type="text" class="form-control" id="industry" 
                                                   name="industry" placeholder="e.g., Technology, Healthcare, Finance" required>
                                            <small class="text-muted">
                                                Enter the specific industry for your company (will be used to tailor executive questions)
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Report Type -->
                                <div class="mb-3">
                                    <label for="report-type" class="form-label">Type of Report/Presentation</label>
                                    <select class="form-select" id="report-type" name="report-type" required>
                                        <option value="">Select Report Type</option>
                                        <option value="Business Plan">Business Plan</option>
                                        <option value="Case Analysis">Case Study Analysis</option>
                                        <option value="Strategic Plan">Strategic Plan</option>
                                        <option value="Market Analysis">Market Analysis</option>
                                        <option value="Financial Proposal">Financial Proposal</option>
                                        <option value="Product Launch">Product Launch Plan</option>
                                        <option value="Consulting Recommendation">Consulting Recommendation</option>
                                        <option value="Investment Pitch">Investment Pitch</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Session Configuration -->
                                <div class="mb-4">
                                    <label class="form-label">Session Configuration</label>
                                    <small class="text-muted d-block mb-3">
                                        Configure how long the executive panel session should run
                                    </small>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="session-type" class="form-label">Session Limit Type</label>
                                                <select class="form-select" id="session-type" name="session-type" required>
                                                    <option value="questions">Number of Questions</option>
                                                    <option value="time">Time Limit</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3" id="question-limit-section">
                                                <label for="question-limit" class="form-label">Total Questions</label>
                                                <select class="form-select" id="question-limit" name="question-limit">
                                                    <option value="6">6 Questions (Short - 5 min)</option>
                                                    <option value="10" selected>10 Questions (Medium - 10 min)</option>
                                                    <option value="15">15 Questions (Long - 15 min)</option>
                                                    <option value="20">20 Questions (Extended - 20 min)</option>
                                                </select>
                                            </div>
                                            <div class="mb-3" id="time-limit-section" style="display: none;">
                                                <label for="time-limit" class="form-label">Time Limit (minutes)</label>
                                                <select class="form-select" id="time-limit" name="time-limit">
                                                    <option value="5">5 Minutes</option>
                                                    <option value="10" selected>10 Minutes</option>
                                                    <option value="15">15 Minutes</option>
                                                    <option value="20">20 Minutes</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Executive Panel Selection -->
                                <div class="mb-4">
                                    <label class="form-label">Select Executive Panel Members</label>
                                    <small class="text-muted d-block mb-2">
                                        Choose executives who will ask questions based on your report content
                                    </small>
                                    <div class="executive-grid">
                                        <div class="executive-card" data-role="CEO">
                                            <input type="checkbox" id="exec-ceo" name="executives" value="CEO">
                                            <label for="exec-ceo">
                                                <div class="exec-icon"><i class="fas fa-crown"></i></div>
                                                <div class="exec-info">
                                                    <strong>CEO</strong>
                                                    <small>Strategy & Vision Questions</small>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="executive-card" data-role="CFO">
                                            <input type="checkbox" id="exec-cfo" name="executives" value="CFO">
                                            <label for="exec-cfo">
                                                <div class="exec-icon"><i class="fas fa-chart-line"></i></div>
                                                <div class="exec-info">
                                                    <strong>CFO</strong>
                                                    <small>Financial Analysis Questions</small>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="executive-card" data-role="CTO">
                                            <input type="checkbox" id="exec-cto" name="executives" value="CTO">
                                            <label for="exec-cto">
                                                <div class="exec-icon"><i class="fas fa-microchip"></i></div>
                                                <div class="exec-info">
                                                    <strong>CTO</strong>
                                                    <small>Technology & Implementation</small>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="executive-card" data-role="CMO">
                                            <input type="checkbox" id="exec-cmo" name="executives" value="CMO">
                                            <label for="exec-cmo">
                                                <div class="exec-icon"><i class="fas fa-bullhorn"></i></div>
                                                <div class="exec-info">
                                                    <strong>CMO</strong>
                                                    <small>Marketing & Customer Questions</small>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="executive-card" data-role="COO">
                                            <input type="checkbox" id="exec-coo" name="executives" value="COO">
                                            <label for="exec-coo">
                                                <div class="exec-icon"><i class="fas fa-cogs"></i></div>
                                                <div class="exec-info">
                                                    <strong>COO</strong>
                                                    <small>Operations & Execution</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-brain"></i>
                                        Analyze Report & Start Presentation
                                    </button>
                                </div>
                                
                                <div id="upload-status" class="mt-3" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Uploading and analyzing your report...</small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Phase -->
        <div id="simulation-phase" class="phase">
            <div class="row">
                <!-- Executive Panel -->
                <div class="col-md-4">
                    <div class="card shadow sticky-top">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-users"></i>
                                Executive Panel
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="executive-list">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversation Area -->
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i>
                                Presentation Simulation
                            </h5>
                            <button id="end-session-btn" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-stop"></i>
                                End Session
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="conversation-area" class="conversation-container">
                                <!-- Conversation messages will appear here -->
                            </div>
                            
                            <div id="response-area" class="mt-3" style="display: none;">
    
    <!-- Mode Toggle Buttons -->
    <div class="response-mode-selector">
        <button id="textModeBtn" class="mode-btn active" onclick="toggleRecordingMode()">
            üí¨ Type Response
        </button>
        <button id="audioModeBtn" class="mode-btn" onclick="toggleRecordingMode()">
            üé§ Record Response
        </button>
    </div>

    <!-- Text Response Section (Default) -->
    <div id="textResponseSection">
        <div class="input-group">
            <textarea id="student-response" 
                      class="form-control" 
                      placeholder="Type your response to the executive..." 
                      rows="3"></textarea>
            <button id="send-response-btn" 
                    class="btn btn-primary" 
                    type="button">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
        <small class="text-muted">Tip: Be specific with data and examples when possible</small>
    </div>

    <!-- Audio Response Section -->
    <div id="audioResponseSection" style="display: none;">
        <div class="audio-controls">
            <button id="recordButton" class="btn-record" onclick="startRecording()">
                üé§ Start Recording
            </button>
            <button id="stopButton" class="btn-stop" onclick="stopRecording()" style="display: none;">
                ‚èπÔ∏è Stop Recording
            </button>
        </div>

        <div id="recordingIndicator" class="recording-indicator" style="display: none;">
            <span class="recording-dot"></span>
            <span>Recording...</span>
            <span id="recordingTimer">00:00</span>
        </div>

        <div id="processingIndicator" class="processing-indicator" style="display: none;">
            <div class="spinner"></div>
            <span>Processing your audio response...</span>
        </div>

        <div id="transcriptionPreview" style="display: none;"></div>
    </div>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Phase -->
        <div id="summary-phase" class="phase">
            <div class="row">
                <div class="col-md-10 mx-auto">
                    <div class="card shadow">
                        <div class="card-header bg-warning text-dark">
                            <h3 class="mb-0">
                                <i class="fas fa-chart-bar"></i>
                                Session Summary & Feedback
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="session-summary">
                                <!-- Summary content populated dynamically -->
                            </div>
                            
                            <div class="mt-4">
                                <div class="alert alert-success">
                                    <h5>Excellent Work!</h5>
                                    <p>You successfully presented to the executive panel and responded to their strategic questions. This type of practice will help you prepare for real-world executive presentations and strategic discussions.</p>
                                </div>

                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-download"></i>
                                            Session Transcript
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Download a complete transcript of your executive panel session including all questions and your responses. This can be useful for:</p>
                                        <ul>
                                            <li>Reviewing your performance and responses</li>
                                            <li>Identifying areas for improvement</li>
                                            <li>Using as reference for future presentations</li>
                                            <li>Submitting as part of course assignments</li>
                                        </ul>
                                        <div class="text-center">
                                            <a href="/download_transcript" class="btn btn-info btn-lg" id="download-transcript-btn">
                                                <i class="fas fa-file-download"></i>
                                                Download Session Transcript
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 text-center">
                                <button id="new-session-btn" class="btn btn-primary btn-lg">
                                    <i class="fas fa-redo"></i>
                                    Start New Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- McCombs Footer -->
        <div class="mccombs-footer">
            <div class="container">
                <p>&copy; 2025 McCombs School of Business, The University of Texas at Austin<br>
                AI Executive Panel Simulator - Developed for Strategic Management Education</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced JavaScript for Executive Panel Simulator
        class ExecutiveSimulator {
            constructor() {
                this.selectedExecutives = [];
                this.currentExecutive = null;
                this.reportUploaded = false;
                this.sessionEnding = false;
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.showPhase('setup');
                // Store reference for global access
                window.simulator = this;
            }
            
            bindEvents() {
                // Setup form with file upload
                document.getElementById('setup-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.uploadReportAndSetup();
                });
                
                // File upload validation
                document.getElementById('report-pdf').addEventListener('change', (e) => {
                    this.validatePDFFile(e.target.files[0]);
                });
                
                // Session type toggle
                document.getElementById('session-type').addEventListener('change', (e) => {
                    this.toggleSessionType(e.target.value);
                });
                
                // Response submission
                document.getElementById('send-response-btn').addEventListener('click', () => {
                    this.sendResponse();
                });
                
                // Enter key in response textarea
                document.getElementById('student-response').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendResponse();
                    }
                });
                
                // End session
                document.getElementById('end-session-btn').addEventListener('click', () => {
                    this.endSession();
                });
                
                // New session
                document.getElementById('new-session-btn').addEventListener('click', () => {
                    this.newSession();
                });
                
                // Executive selection
                document.querySelectorAll('.executive-card input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        this.updateSelectedExecutives();
                    });
                });
            }
            
            toggleSessionType(sessionType) {
                const questionSection = document.getElementById('question-limit-section');
                const timeSection = document.getElementById('time-limit-section');
                
                if (sessionType === 'questions') {
                    questionSection.style.display = 'block';
                    timeSection.style.display = 'none';
                } else {
                    questionSection.style.display = 'none';
                    timeSection.style.display = 'block';
                }
            }
            
            validatePDFFile(file) {
                if (!file) return;
                
                // Check file type
                if (file.type !== 'application/pdf') {
                    alert('Please upload a PDF file only.');
                    document.getElementById('report-pdf').value = '';
                    return false;
                }
                
                // Check file size (16MB limit)
                const maxSize = 16 * 1024 * 1024; // 16MB
                if (file.size > maxSize) {
                    alert('File too large. Please upload a PDF smaller than 16MB.');
                    document.getElementById('report-pdf').value = '';
                    return false;
                }
                
                console.log(`PDF file selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                return true;
            }
            
            updateSelectedExecutives() {
                this.selectedExecutives = [];
                document.querySelectorAll('.executive-card input[type="checkbox"]:checked').forEach(checkbox => {
                    this.selectedExecutives.push(checkbox.value);
                });
            }
            
            showPhase(phaseName) {
                document.querySelectorAll('.phase').forEach(phase => {
                    phase.classList.remove('active');
                });
                document.getElementById(`${phaseName}-phase`).classList.add('active');
            }
            
            async uploadReportAndSetup() {
                // Validate form
                if (this.selectedExecutives.length === 0) {
                    alert('Please select at least one executive for the panel.');
                    return;
                }
                
                const fileInput = document.getElementById('report-pdf');
                const companyName = document.getElementById('company-name').value;
                const industry = document.getElementById('industry').value;
                const reportType = document.getElementById('report-type').value;
                const sessionType = document.getElementById('session-type').value;
                const questionLimit = document.getElementById('question-limit').value;
                const timeLimit = document.getElementById('time-limit').value;
                
                if (!fileInput.files[0] || !companyName || !industry || !reportType) {
                    alert('Please fill in all required fields and upload a PDF report.');
                    return;
                }
                
                // Validate PDF file
                if (!this.validatePDFFile(fileInput.files[0])) {
                    return;
                }
                
                // Show upload progress
                this.showUploadProgress();
                
                try {
                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('report', fileInput.files[0]);
                    formData.append('company_name', companyName);
                    formData.append('industry', industry);
                    formData.append('report_type', reportType);
                    formData.append('session_type', sessionType);
                    formData.append('question_limit', questionLimit);
                    formData.append('time-limit', timeLimit);
                    
                    // Append selected executives
                    this.selectedExecutives.forEach(exec => {
                        formData.append('executives[]', exec);
                    });
                    
                    const response = await fetch('/upload_report', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.hideUploadProgress();
                        this.reportUploaded = true;
                        this.setupSimulationPhase();
                        this.startPresentation();
                    } else {
                        throw new Error(data.error || 'Failed to setup session');
                    }
                } catch (error) {
                    this.hideUploadProgress();
                    alert('Error uploading report: ' + error.message);
                }
            }
            
            showUploadProgress() {
                const statusDiv = document.getElementById('upload-status');
                statusDiv.style.display = 'block';
                
                // Simulate progress
                const progressBar = statusDiv.querySelector('.progress-bar');
                let progress = 0;
                
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    
                    progressBar.style.width = progress + '%';
                    
                    if (progress >= 90) {
                        clearInterval(interval);
                    }
                }, 200);
                
                // Store interval to clear it later
                this.uploadInterval = interval;
            }
            
            hideUploadProgress() {
                const statusDiv = document.getElementById('upload-status');
                statusDiv.style.display = 'none';
                
                const progressBar = statusDiv.querySelector('.progress-bar');
                progressBar.style.width = '100%';
                
                if (this.uploadInterval) {
                    clearInterval(this.uploadInterval);
                }
            }
            
            setupSimulationPhase() {
                const executiveList = document.getElementById('executive-list');
                executiveList.innerHTML = '';
                
                const executives = {
                    'CEO': { name: 'Sarah Chen', icon: 'fa-crown' },
                    'CFO': { name: 'Michael Rodriguez', icon: 'fa-chart-line' },
                    'CTO': { name: 'Dr. Lisa Wang', icon: 'fa-microchip' },
                    'CMO': { name: 'James Thompson', icon: 'fa-bullhorn' },
                    'COO': { name: 'Rebecca Johnson', icon: 'fa-cogs' }
                };
                
                this.selectedExecutives.forEach(role => {
                    const exec = executives[role];
                    const execElement = document.createElement('div');
                    execElement.className = 'executive-member';
                    execElement.innerHTML = `
                        <div class="avatar avatar-${role}">
                            <i class="fas ${exec.icon}"></i>
                        </div>
                        <div class="info">
                            <div class="name">${exec.name}</div>
                            <div class="title">${role}</div>
                        </div>
                    `;
                    executiveList.appendChild(execElement);
                });
                
                this.showPhase('simulation');
            }
            
            async startPresentation() {
                this.showLoadingMessage('AI executives are analyzing your report and preparing personalized questions...');
                
                try {
                    const response = await fetch('/upload_report', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.hideLoadingMessage();
                        this.displayInitialQuestions(data.initial_questions);
                    } else {
                        throw new Error(data.error || 'Failed to start presentation');
                    }
                } catch (error) {
                    this.hideLoadingMessage();
                    alert('Error starting presentation: ' + error.message);
                }
            }
            
            displayInitialQuestions(questions) {
                const conversationArea = document.getElementById('conversation-area');
                conversationArea.innerHTML = '';
                
                // Add welcome message with report confirmation
                this.addWelcomeMessage();
                
                // Add first executive question
                if (questions.length > 0) {
                    const firstQuestion = questions[0];
                    this.addExecutiveMessage(firstQuestion);
                    this.currentExecutive = firstQuestion.executive;
                    this.showResponseArea(firstQuestion.executive);
                }
            }
            
            addWelcomeMessage() {
                const conversationArea = document.getElementById('conversation-area');
                const welcomeElement = document.createElement('div');
                welcomeElement.className = 'alert alert-success text-center';
                welcomeElement.innerHTML = `
                    <i class="fas fa-file-pdf text-danger"></i>
                    <strong>Report Analyzed Successfully!</strong><br>
                    Your executives have reviewed your report and are ready with personalized questions based on your content.
                `;
                conversationArea.appendChild(welcomeElement);
            }
            
            addExecutiveMessage(questionData) {
                const conversationArea = document.getElementById('conversation-area');
                const messageElement = document.createElement('div');
                messageElement.className = 'message executive';
                
                const time = new Date(questionData.timestamp).toLocaleTimeString();
                const icon = this.getExecutiveIcon(questionData.executive);
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="executive-avatar avatar-${questionData.executive}">
                            ${icon}
                        </div>
                        <div>
                            <strong>${questionData.name}</strong>
                            <small class="text-muted d-block">${questionData.title}</small>
                        </div>
                    </div>
                    <div class="message-bubble">
                        <p class="mb-0">${questionData.question}</p>
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                conversationArea.appendChild(messageElement);
                this.scrollToBottom();
                this.setActiveExecutive(questionData.executive);
            }
            
            addStudentMessage(response) {
                const conversationArea = document.getElementById('conversation-area');
                const messageElement = document.createElement('div');
                messageElement.className = 'message student';
                
                const time = new Date().toLocaleTimeString();
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div>
                            <strong>You</strong>
                            <small class="text-muted d-block">Student Response</small>
                        </div>
                        <div class="student-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="message-bubble">
                        <p class="mb-0">${response}</p>
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                conversationArea.appendChild(messageElement);
                this.scrollToBottom();
            }
            
            getExecutiveIcon(role) {
                const icons = {
                    'CEO': '<i class="fas fa-crown"></i>',
                    'CFO': '<i class="fas fa-chart-line"></i>',
                    'CTO': '<i class="fas fa-microchip"></i>',
                    'CMO': '<i class="fas fa-bullhorn"></i>',
                    'COO': '<i class="fas fa-cogs"></i>'
                };
                return icons[role] || '<i class="fas fa-user"></i>';
            }
            
            setActiveExecutive(role) {
                document.querySelectorAll('.executive-member').forEach(member => {
                    member.classList.remove('active');
                });
                
                document.querySelectorAll('.executive-member').forEach(member => {
                    const titleElement = member.querySelector('.title');
                    if (titleElement && titleElement.textContent === role) {
                        member.classList.add('active');
                    }
                });
            }
            
            showResponseArea(executive) {
                if (this.sessionEnding) return;
                
                const responseArea = document.getElementById('response-area');
                responseArea.style.display = 'block';
                
                const textarea = document.getElementById('student-response');
                textarea.placeholder = `Respond to the ${executive}...`;
                textarea.focus();
            }
            
            hideResponseArea() {
                document.getElementById('response-area').style.display = 'none';
            }
            
            async sendResponse() {
                const responseText = document.getElementById('student-response').value.trim();
                
                if (!responseText) {
                    alert('Please enter a response.');
                    return;
                }
                
                if (!this.currentExecutive) {
                    alert('No active question to respond to.');
                    return;
                }
                
                this.addStudentMessage(responseText);
                document.getElementById('student-response').value = '';
                this.hideResponseArea();
                
                this.showLoadingMessage('Executive is considering your response...');
                
                try {
                    const response = await fetch('/respond_to_executive', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            response: responseText,
                            executive_role: this.currentExecutive
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.hideLoadingMessage();
                        
                        if (data.follow_up) {
                            setTimeout(() => {
                                this.addExecutiveMessage(data.follow_up);
                                this.currentExecutive = data.follow_up.executive;
                                
                                // Check if this is a closing message or session is ending
                                if (data.follow_up.is_closing || data.session_ending) {
                                    this.sessionEnding = true;
                                    // Don't show response area for closing messages
                                    setTimeout(() => {
                                        this.showSessionEndedMessage();
                                    }, 3000); // Wait 3 seconds then show summary
                                } else {
                                    this.showResponseArea(data.follow_up.executive);
                                }
                            }, 1000);
                        }
                    } else {
                        throw new Error(data.error || 'Failed to get response');
                    }
                } catch (error) {
                    this.hideLoadingMessage();
                    alert('Error getting executive response: ' + error.message);
                    this.showResponseArea(this.currentExecutive);
                }
            }
            
            showSessionEndedMessage() {
                const conversationArea = document.getElementById('conversation-area');
                const endMessageElement = document.createElement('div');
                endMessageElement.className = 'alert alert-info text-center mt-3';
                endMessageElement.innerHTML = `
                    <h5><i class="fas fa-clock"></i> Session Complete</h5>
                    <p>The executive panel session has ended. Thank you for your presentation!</p>
                    <button class="btn btn-primary" onclick="simulator.endSession()">
                        View Summary & Feedback
                    </button>
                `;
                conversationArea.appendChild(endMessageElement);
                this.scrollToBottom();
            }
            
            showLoadingMessage(text) {
                const conversationArea = document.getElementById('conversation-area');
                const loadingElement = document.createElement('div');
                loadingElement.className = 'loading-message';
                loadingElement.id = 'loading-message';
                loadingElement.innerHTML = `
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">${text}</p>
                `;
                conversationArea.appendChild(loadingElement);
                this.scrollToBottom();
            }
            
            hideLoadingMessage() {
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
            }
            
            async endSession() {
                try {
                    const response = await fetch('/end_session', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.showSessionSummary(data.summary);
                    }
                } catch (error) {
                    alert('Error ending session: ' + error.message);
                }
            }
            
            showSessionSummary(summary) {
                const summaryContainer = document.getElementById('session-summary');
                summaryContainer.innerHTML = `
                    <div class="text-center">
                        <h4>Presentation Session Complete!</h4>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Session Details</h5>
                                        <p><strong>Company:</strong> ${summary.company_name}</p>
                                        <p><strong>Report Type:</strong> ${summary.presentation_topic}</p>
                                        <p><strong>Session Type:</strong> ${summary.session_type === 'questions' ? 'Question-based' : 'Time-based'}</p>
                                        <p><strong>Limit:</strong> ${summary.session_limit} ${summary.session_type === 'questions' ? 'questions' : 'minutes'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Performance</h5>
                                        <p><strong>Questions Asked:</strong> ${summary.total_questions}</p>
                                        <p><strong>Responses Given:</strong> ${summary.total_responses}</p>
                                        <p><strong>Executives Involved:</strong> ${summary.executives_involved.join(', ')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.showPhase('summary');
            }
            
            newSession() {
                this.selectedExecutives = [];
                this.currentExecutive = null;
                this.reportUploaded = false;
                this.sessionEnding = false;
                
                document.getElementById('setup-form').reset();
                document.querySelectorAll('.executive-card input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset session type display
                this.toggleSessionType('questions');
                
                this.showPhase('setup');
            }
            
            scrollToBottom() {
                const conversationArea = document.getElementById('conversation-area');
                conversationArea.scrollTop = conversationArea.scrollHeight;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ExecutiveSimulator();
        });
    </script>
       <!-- Audio Recorder Script -->
    <script src="{{ url_for('static', filename='js/audio-recorder.js') }}"></script>
    
</body>
</html>
